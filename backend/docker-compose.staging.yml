services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.staging
    image: ptb-ot-backend:staging
    container_name: ptb-ot-backend
    restart: unless-stopped
    # Use Daphne ASGI server for WebSocket support (Kanban real-time features)
    command: daphne -b 0.0.0.0 -p 8008 --application-close-timeout 30 backend.asgi:application
    volumes:
      # Mount source code for hot reload
      - ./api:/app/api
      - ./backend:/app/backend
      - ./scripts:/app/scripts
      - ./manage.py:/app/manage.py
      - ./.env.staging:/app/.env.staging
      # Persistent data volumes
      - static_volume:/app/staticfiles
      - media_volume:/app/mediafiles
      - log_volume:/app/logs
    ports:
      - "8008:8008"
    env_file:
      - .env.staging
    environment:
      - DJANGO_ENV=development  # Keep in dev mode for hot reload
      - APP_PORT=8008
      - PYTHONPATH=/app
    # Use host network to access existing Redis on host
    network_mode: "host"
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8008/api/health/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    labels:
      - "com.ptb-ot.service=backend"
      - "com.ptb-ot.environment=staging"

  celery:
    build:
      context: .
      dockerfile: Dockerfile.staging
    image: ptb-ot-backend:staging
    container_name: ptb-ot-celery
    restart: unless-stopped
    # Limit concurrency to 2 workers â€” this service handles Excel generation,
    # not high-throughput tasks. Keeps memory usage low.
    command: celery -A backend worker -l info --concurrency=2
    volumes:
      - ./api:/app/api
      - ./backend:/app/backend
      - ./manage.py:/app/manage.py
      - ./.env.staging:/app/.env.staging
      - log_volume:/app/logs
    env_file:
      - .env.staging
    environment:
      - PYTHONPATH=/app
    # Use host network to access existing Redis on host
    network_mode: "host"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "25m"
        max-file: "5"
    labels:
      - "com.ptb-ot.service=celery"
      - "com.ptb-ot.environment=staging"

volumes:
  static_volume:
  media_volume:
  log_volume:
